name: autocommit-robot

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ACCOUNT_TOKEN }}
          submodules: true

      - name: "Set node"
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Cache node modules
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            node_modules
            ~/.yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Install"
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile

      - name: "Generate commit message"
        id: commit-message
        run: |
          # ‰øùÊåÅÂéüÊúâÁöÑÈöèÊú∫Ê∂àÊÅØÁîüÊàêÈÄªËæë
          echo "message=ü§ñ chore: Auto update [$(date '+%Y-%m-%d %H:%M:%S')]" >> $GITHUB_OUTPUT

      - name: "Run bash"
        run: yarn writer

      - name: "Configure Git"
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ secrets.ACCOUNT_TOKEN }} | base64)"

      - name: "Install Hexo"
        run: |
          yarn global add hexo-cli
          yarn add hexo-deployer-git

      - name: "Build and Deploy Hexo"
        run: |
          hexo clean
          hexo generate
          # ‰øÆÊîπHexoÈÖçÁΩÆ‰ΩøÁî®HTTPS+TokenÊñπÂºèÈÉ®ÁΩ≤
          sed -i 's/git@github.com:/https:\/\/${{ secrets.ACCOUNT_TOKEN }}@github.com\//' _config.yml
          hexo deploy --message "${{ steps.commit-message.outputs.message }}"

      - name: "Commit and Push Source Changes"
        run: |
          git add source/*
          git commit -m "${{ steps.commit-message.outputs.message }}" || echo "No changes to commit"
          git push origin HEAD:${GITHUB_REF#refs/heads/}
